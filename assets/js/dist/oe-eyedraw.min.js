/*! eyedraw 29-10-2014 */
var ED=ED||{};ED.init=function(){"use strict";function a(b,c,d,e){if(e||(e=(new Date).getTime()),(new Date).getTime()-e>=c)return ED.errorHandler("OEEyeDraw.js","waitForStyleSheet","Unable to init eyedraw, stylesheet is not loaded.");for(var f=window.document.styleSheets,g=0,h=f.length;h>g;g++){var i=f[g];if(i.href&&i.href.indexOf(b)>=0)return d()}window.setTimeout(a.bind(null,b,c,d,e),100)}return function(b,c){c=$.isFunction(c)?c:$.noop,a("oe-eyedraw",5e3,function(){c(new ED.Controller(b))})}}();var ED=ED||{};ED.Checker=ED.Checker||function(){"use strict";function a(){$("canvas").each(function(){var a=$(this),b=this.id;(a.hasClass("ed-canvas-edit")||a.hasClass("ed-canvas-display"))&&-1===j.indexOf(b)&&j.push(b)})}function b(){i.forEach(function(a){a()})}function c(a){l[a.drawingName]=a,a.registerForNotifications({callback:function(){var c=a.canvas.id;-1===k.indexOf(c)&&k.push(c),d()&&b()}},"callback",["doodlesLoaded"])}function d(){return j.length===k.length}function e(a){d()?a():i.push(a)}function f(a){return l[a]}function g(a){return Object.keys(l).filter(function(b){return l[b].idSuffix===a}).map(function(a){return l[a]})[0]}function h(){l={},i=[],j=[]}var i=[],j=[],k=[],l={};return $(a),ED.getInstance=f,{register:c,onAllReady:e,getInstance:f,getInstanceByIdSuffix:g,reset:h,registerForReady:e}}(),window.getOEEyeDrawChecker=function(){return ED.Checker};var ED=ED||{};ED.Controller=function(){"use strict";function a(a,b,c,d,e,f,g){this.properties=a,this.canvas=document.getElementById(a.canvasId),this.input=document.getElementById(a.inputId),this.container=$(this.canvas).closest(".ed-widget"),this.Checker=b||ED.Checker,this.drawing=c||this.createDrawing(),this.properties.isEditable&&(this.mainToolbar=d||this.createMainToolbar(),this.drawingToolbar=e||this.createDrawingToolbar(),this.doodlePopup=f||this.createDoodlePopup(),this.selectedDoodle=g||this.createSelectedDoodle(),this.bindEditEvents()),this.registerDrawing(),this.registerForNotifications(),this.initListeners(),this.drawing.init()}var b=ED.firstLetterToUpperCase;return a.prototype.createDrawing=function(){var a={drawingName:this.properties.drawingName,offsetX:this.properties.offsetX,offsetY:this.properties.offsetY,toImage:this.properties.toImage,graphicsPath:this.properties.graphicsPath,scale:this.properties.scale,toggleScale:this.properties.toggleScale},b=new ED.Drawing(this.canvas,this.properties.eye,this.properties.idSuffix,this.properties.isEditable,a);return b},a.prototype.createMainToolbar=function(){var a=this.container.find(".ed-main-toolbar");return a.length?new ED.Views.Toolbar.Main(this.drawing,a):null},a.prototype.createDrawingToolbar=function(){var a=this.container.find(".ed-drawing-toolbar");return a.length?new ED.Views.Toolbar.Drawing(this.drawing,a):null},a.prototype.createDoodlePopup=function(){var a=this.container.find(".ed-doodle-popup");return a.length?new ED.Views.DoodlePopup(this.drawing,a):null},a.prototype.createSelectedDoodle=function(){var a=this.container.find(".ed-selected-doodle");return a.length?new ED.Views.SelectedDoodle(this.drawing,a,this.doodlePopup):null},a.prototype.registerDrawing=function(){this.Checker.register(this.drawing)},a.prototype.registerForNotifications=function(){this.drawing.registerForNotifications(this,"notificationHandler",["ready","doodlesLoaded","parameterChanged"]),this.drawing.registerForNotifications(this,"saveDrawingToInputField",["doodleAdded","doodleDeleted","doodleSelected","mousedragged","drawingZoom"])},a.prototype.bindEditEvents=function(){this.doodlePopup&&this.doodlePopup instanceof ED.Views.DoodlePopup&&(this.doodlePopup.on("show.before",function(){this.container.addClass("ed-state-doodle-popup-show")}.bind(this)),this.doodlePopup.on("hide.after",function(){this.container.removeClass("ed-state-doodle-popup-show")}.bind(this)))},a.prototype.initListeners=function(){this.properties.listenerArray instanceof Array&&this.properties.listenerArray.forEach(function(a){new a(this.drawing)}.bind(this))},a.prototype.notificationHandler=function(a){var c=a.eventName,d="on"+b(c);this[d]&&this[d](a)},a.prototype.hasInputFieldData=function(){return this.hasInputField()&&this.input.value.length>0},a.prototype.hasInputField=function(){return null!==this.input},a.prototype.saveDrawingToInputField=function(a){(a&&this.hasInputField()||this.hasInputFieldData())&&(this.input.value=this.drawing.save())},a.prototype.loadInputFieldData=function(){this.drawing.loadDoodles(this.properties.inputId)},a.prototype.addBindings=function(){ED.objectIsEmpty(this.properties.bindingArray)||this.drawing.addBindings(this.properties.bindingArray)},a.prototype.addDeletedValues=function(){ED.objectIsEmpty(this.properties.deleteValueArray)||this.drawing.addDeleteValues(this.properties.deleteValueArray)},a.prototype.deselectSyncedDoodles=function(){var a=this.properties.syncArray;for(var b in a)this.getEyeDrawInstance(b).deselectDoodles()},a.prototype.runOnReadyCommands=function(){var a=this.properties.onReadyCommandArray||[];this.runCommands(a),this.drawing.onReadyCommands.push(a)},a.prototype.runOnDoodlesLoadedCommands=function(){var a=this.properties.onDoodlesLoadedCommandArray||[];this.runCommands(a)},a.prototype.runCommands=function(a){for(var b=0;b<a.length;b++){var c=a[b][0],d=a[b][1];this.drawing[c].apply(this.drawing,d)}},a.prototype.getEyeDrawInstance=function(a){return ED.Checker.getInstanceByIdSuffix(a)},a.prototype.syncEyedraws=function(a){var b=a.doodle,c=this.properties.syncArray;for(var d in c){var e=this.getEyeDrawInstance(d);if(!e){ED.errorHandler("ED.Controller","syncEyedraws","Cannot sync with "+d+": instance not found");break}for(var f in c[d])for(var g in c[d][f]){var h=e.firstDoodleOfClass(g);if(b&&b.className===f&&(h||h.willSync)){var i=c[d][f][g].parameters;this.syncDoodleParameters(i,a,b,h,e)}}e.repaint()}},a.prototype.syncDoodleParameters=function(a,b,c,d,e){for(var f=0;f<(a||[]).length;f++)if(a[f]===b.parameter&&c[b.parameter]!==d[b.parameter]){var g=b.value-b.oldValue,h=d[b.parameter]+g;d.setSimpleParameter(b.parameter,h),d.updateDependentParameters(b.parameter),e.updateBindings(d)}},a.prototype.onReady=function(){this.hasInputFieldData()?(this.loadInputFieldData(),this.drawing.repaint()):this.runOnReadyCommands(),this.addBindings(),this.addDeletedValues(),this.drawing.notifyZoomLevel(),this.saveDrawingToInputField(!0),this.properties.focus&&this.canvas.focus(),this.drawing.isReady=!0},a.prototype.onDoodlesLoaded=function(){this.runOnDoodlesLoadedCommands()},a.prototype.onParameterChanged=function(a){this.syncEyedraws(a.object),this.saveDrawingToInputField()},a}();var ED=ED||{};ED.View=function(){"use strict";function a(){EventEmitter2.call(this),this.delayTimer=0}var b=ED.firstLetterToUpperCase;return a.prototype=Object.create(EventEmitter2.prototype),a.prototype.constructor=a,a.prototype.notificationHandler=function(a){var c=a.eventName,d="on"+b(c);this[d]||console.error("No handler defined for event:",d),this[d](a)},a.prototype.delay=function(a,b){clearTimeout(this.delayTimer),b="number"==typeof b?b:50,this.delayTimer=setTimeout(a,b)},a}();var ED=ED||{};ED.Views=ED.Views||{},ED.Views.DoodlePopup=function(){"use strict";function a(a,b){ED.View.apply(this,arguments),this.drawing=a,this.container=b,this.containerWidth=b.outerWidth(),this.registerForNotifications(),this.createToolbar(),this.createHelpButton(),this.createTemplate()}var b=440;return a.prototype=Object.create(ED.View.prototype),a.prototype.constructor=a,a.prototype.createToolbar=function(){this.toolbar=new ED.Views.Toolbar(this.drawing,this.container),this.toolbar.on("button.action",this.render.bind(this))},a.prototype.createHelpButton=function(){this.helpButton=new ED.Views.DoodlePopup.Help(this)},a.prototype.createTemplate=function(){this.template=ED.scriptTemplates["doodle-popup"]},a.prototype.registerForNotifications=function(){this.drawing.registerForNotifications(this,"notificationHandler",["doodleAdded","doodleDeleted","doodleSelected","doodleDeselected"])},a.prototype.render=function(){var a=this.drawing.selectedDoodle;if(a){var b={doodle:a,drawing:this.drawing,title:ED.titles[a.className],desc:ED.trans[a.className],lockedButtonClass:a.isLocked?" disabled":""},c=Mustache.render(this.template,b);this.container.empty(),this.container.html(c),a.showDoodleControls(),this.emit("render")}},a.prototype.update=function(a){a&&this.drawing.selectedDoodle?(this.render(),this.show()):this.hide()},a.prototype.hide=function(){this.delay(function(){this.emit("hide.before"),this.container.css({right:0}),setTimeout(function(){this.container.addClass("closed"),this.emit("hide.after")}.bind(this),b)}.bind(this))},a.prototype.show=function(){this.delay(function(){this.emit("show.before"),this.container.css({right:-1*(this.containerWidth-1)}).removeClass("closed"),setTimeout(function(){this.emit("show.after")}.bind(this),b)}.bind(this))},a.prototype.onDoodleAdded=function(){this.drawing.selectDoodle(this.drawing.selectedDoodle)},a.prototype.onDoodleDeleted=function(){this.update(!1)},a.prototype.onDoodleSelected=function(){this.update(!0)},a.prototype.onDoodleDeselected=function(){var a=!!this.drawing.selectedDoodle;a||this.update(!1)},a}();var ED=ED||{};ED.Views=ED.Views||{},ED.Views.DoodlePopup.Help=function(){"use strict";function a(a){return function(b){return b.button.hasClass("ed-doodle-help")&&!b.button.hasClass("disabled")&&a(b)}}function b(a){this.doodlePopup=a,this.locked=!1,this.delayTimer=0,this.bindEvents()}return b.prototype.bindEvents=function(){var b=this.doodlePopup;b.on("render",this.onDoodlePopupRender.bind(this)),b.on("hide",this.onDoodlePopupHide.bind(this));var c=b.toolbar;c.on("button.mouseenter",a(this.onButtonMouseEnter.bind(this))),c.on("button.mouseleave",a(this.onButtonMouseLeave.bind(this))),c.on("button.action",a(this.onButtonMouseClick.bind(this)))},b.prototype.showDescription=function(){clearTimeout(this.delayTimer),this.button.addClass("hover"),this.doodleInfo.show(),this.doodleControls.hide()},b.prototype.hideDescription=function(){clearTimeout(this.delayTimer),this.button.removeClass("hover"),this.doodleInfo.hide(),this.doodleControls.show()},b.prototype.onDoodlePopupRender=function(){this.doodleInfo=this.doodlePopup.container.find(".ed-doodle-info"),this.doodleControls=this.doodlePopup.container.find(".ed-doodle-controls"),this.button=this.doodlePopup.toolbar.container.find(".ed-doodle-help")},b.prototype.onDoodlePopupHide=function(){this.locked=!1},b.prototype.onButtonMouseEnter=function(){this.delayTimer=setTimeout(this.showDescription.bind(this),300)},b.prototype.onButtonMouseLeave=function(){this.locked||this.hideDescription()},b.prototype.onButtonMouseClick=function(){this.locked?this.hideDescription():this.showDescription(),this.locked=!this.locked},b}();var ED=ED||{};ED.Views=ED.Views||{},ED.Views.SelectedDoodle=function(){"use strict";function a(a,b,c){ED.View.apply(this,arguments),this.drawing=a,this.container=b,this.select=this.container.find("select"),this.doodlePopup=c,this.registerForNotifications(),this.bindEvents()}var b="eyedraw.selected-doodle";return a.prototype=Object.create(ED.View.prototype),a.prototype.constructor=a,a.prototype.registerForNotifications=function(){this.drawing.registerForNotifications(this,"render",["ready","doodleAdded","doodleDeleted","doodleSelected","doodleDeselected","doodlesLoaded","moveToFront","moveToBack","doodleLocked","doodleUnlocked"])},a.prototype.bindEvents=function(){this.select.on("change."+b,this.onSelectChange.bind(this))},a.prototype.render=function(){var a=$('<optgroup label="Selected doodle" />'),b="None",c=null===this.drawing.selectedDoodle;a.append(this.createOption(b,c));var d=this.drawing.doodleArray.slice();d.reverse();var e=d.map(this.createDoodleOption.bind(this));a.append(e),this.select.html(a)},a.prototype.createOption=function(a,b){return $("<option />",{text:a,selected:b})},a.prototype.createDoodleOption=function(a){var b=ED.titles[a.className]||a.className,c=a===this.drawing.selectedDoodle,d=this.drawing.doodleArray.filter(function(b){return b.className===a.className}).sort(function(a,b){return a.createdTime-b.createdTime});if(d.length>1){var e=d.indexOf(a);b+=" ("+(e+1)+")"}a.isLocked&&(b+=" (*)");var f=this.createOption(b,c);return f.data("doodle",a),f},a.prototype.onSelectChange=function(a){var b=$(a.target).find(":selected").data("doodle");b?this.drawing.selectDoodle(b):this.drawing.deselectDoodles()},a}();var ED=ED||{};ED.Views=ED.Views||{},ED.Views.Toolbar=function(){"use strict";function a(a,b){ED.View.apply(this,arguments),this.drawing=a,this.container=$(b),this.buttons=this.container.find(".ed-button"),this.registerForNotifications(),this.bindEvents()}var b="eyedraw.toolbar";return a.prototype=Object.create(ED.View.prototype),a.prototype.constructor=a,a.prototype.registerForNotifications=function(){this.drawing.registerForNotifications(this,"updateState",["doodleAdded","doodleDeleted"])},a.prototype.bindEvents=function(){$(document).click(this.hideDrawers.bind(this)),this.container.on("click."+b,".ed-button-more",this.onMoreButtonClick.bind(this)).on("click."+b,".ed-button",this.onButtonClick.bind(this)).on("mouseenter."+b,".ed-button",this.onButtonMouseEnter.bind(this)).on("mouseleave."+b,".ed-button",this.onButtonMouseLeave.bind(this))},a.prototype.enableButton=function(a){a.attr("disabled",!1).removeClass("disabled")},a.prototype.disableButton=function(a){a.attr("disabled",!0).addClass("disabled")},a.prototype.updateButtonState=function(a){this.enableButton(a);var b=a.data("function"),c=a.data("arg");if("addDoodle"===b){var d=this.drawing.doodleArray.filter(function(a){return a.className===c})[0];d&&d.isUnique&&this.disableButton(a)}},a.prototype.updateState=function(){this.buttons.each(function(a,b){this.updateButtonState($(b))}.bind(this))},a.prototype.execButtonFunction=function(a){if(!a.hasClass("disabled")){var b=a.data("function"),c=a.data("arg");b&&"function"==typeof this.drawing[b]?this.drawing[b](c):this.emit("button.error","Invalid doodle function: "+b),this.emit("button.action",{fn:b,arg:c,button:a})}},a.prototype.hideDrawers=function(){var a=this.container.find(".ed-drawer-open");a.removeClass("ed-drawer-open")},a.prototype.onButtonClick=function(a){a.preventDefault(),a.stopImmediatePropagation(),this.hideDrawers();var b=$(a.currentTarget);this.execButtonFunction(b)},a.prototype.onMoreButtonClick=function(a){a.preventDefault(),a.stopImmediatePropagation(),this.hideDrawers();var b=$(a.currentTarget);b.closest("li").addClass("ed-drawer-open")},a.prototype.onButtonMouseEnter=function(a){this.emit("button.mouseenter",{button:$(a.currentTarget)})},a.prototype.onButtonMouseLeave=function(a){this.emit("button.mouseleave",{button:$(a.currentTarget)})},a}(),ED.Views.Toolbar.Drawing=function(){function a(){ED.Views.Toolbar.apply(this,arguments),this.zoomIcon=this.container.find("[class^=icon-ed-zoom]")}return a.prototype=Object.create(ED.Views.Toolbar.prototype),a.prototype.constructor=a,a.prototype.registerForNotifications=function(){ED.Views.Toolbar.prototype.registerForNotifications.apply(this,arguments),this.drawing.registerForNotifications(this,"handleZoom",["drawingZoomOut","drawingZoomIn"])},a.prototype.handleZoom=function(a){switch(a.eventName){case"drawingZoomIn":this.updateIcon("icon-ed-zoom-out");break;case"drawingZoomOut":this.updateIcon("icon-ed-zoom-in")}},a.prototype.updateIcon=function(a){this.zoomIcon.removeClass("icon-ed-zoom-in icon-ed-zoom-out").addClass(a)},a}(),ED.Views.Toolbar.Main=function(){function a(){ED.Views.Toolbar.apply(this,arguments)}return a.prototype=Object.create(ED.Views.Toolbar.prototype),a.prototype.constructor=a,a}(),ED.scriptTemplates={"doodle-popup":'\n\n\n\n{{#doodle}}\n	<ul class="ed-toolbar-panel ed-doodle-popup-toolbar">\n		<li>\n			{{#desc}}\n				<a class="ed-button ed-doodle-help{{lockedButtonClass}}" href="#" data-function="toggleHelp">\n					<span class="icon-ed-help"></span>\n				</a>\n			{{/desc}}\n		</li>\n		{{#doodle.isLocked}}\n			<li>\n				<a class="ed-button" href="#" data-function="unlock">\n					<span class="icon-ed-unlock"></span>\n					<span class="label">Unlock</span>\n				</a>\n			</li>\n		{{/doodle.isLocked}}\n		{{^doodle.isLocked}}\n			<li>\n				<a class="ed-button" href="#" data-function="lock">\n					<span class="icon-ed-lock"></span>\n					<span class="label">Lock</span>\n				</a>\n			</li>\n		{{/doodle.isLocked}}\n		<li>\n			<a class="ed-button{{lockedButtonClass}}" href="#" data-function="moveToBack">\n				<span class="icon-ed-move-to-back"></span>\n				<span class="label">Move to back</span>\n			</a>\n		</li>\n		<li>\n			<a class="ed-button{{lockedButtonClass}}" href="#" data-function="moveToFront">\n				<span class="icon-ed-move-to-front"></span>\n				<span class="label">Move to front</span>\n			</a>\n		</li>\n		<li>\n			{{#doodle.isDeletable}}\n				<a class="ed-button{{lockedButtonClass}}" href="#" data-function="deleteSelectedDoodle">\n					<span class="icon-ed-delete"></span>\n					<span class="label">Delete</span>\n				</a>\n			{{/doodle.isDeletable}}\n		</li>\n	</ul>\n	<div class="ed-doodle-info hide">\n		{{^doodle.isLocked}}\n			{{#desc}}\n				<div class="ed-doodle-description">{{{desc}}}</div>\n			{{/desc}}\n		{{/doodle.isLocked}}\n	</div>\n	<div class="ed-doodle-controls{{#doodle.isLocked}} hide{{/doodle.isLocked}}" id="{{drawing.canvas.id}}_controls">\n	</div>\n	{{#doodle.isLocked}}\n		<div class="ed-doodle-description">\n			<strong>This doodle is locked and cannot be edited.</strong>\n		</div>\n	{{/doodle.isLocked}}\n{{/doodle}}'};