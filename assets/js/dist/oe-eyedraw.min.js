/*! eyedraw 10-07-2020 */

var ED;(ED=ED||{}).init=function(){"use strict";return function(t,e){(e=$.isFunction(e)?e:$.noop)(new ED.Controller(t))}}(),(ED=ED||{}).Checker=ED.Checker||function(){"use strict";var t=[],e=[],o=[],i={};function n(t){-1===e.indexOf(t)&&e.push(t)}function s(){return e.length===o.length}function r(e){s()?e():t.push(e)}function a(t){return i[t]}return $(function(){$("canvas").each(function(){var t=$(this),e=this.id;(t.hasClass("ed-canvas-edit")||t.hasClass("ed-canvas-display"))&&n(e)})}),ED.getInstance=a,{register:function(e){i[e.drawingName]=e,n(e.canvas.id),e.registerForNotifications({callback:function(){var i=e.canvas.id;-1===o.indexOf(i)&&o.push(i),s()&&(t.forEach(function(t){t()}),t=[])}},"callback",["ready"])},onAllReady:r,isReady:s,getInstance:a,getInstanceByIdSuffix:function(t){return Object.keys(i).filter(function(e){return i[e].idSuffix===t}).map(function(t){return i[t]})[0]},reset:function(){i={},t=[],e=[]},resync:function(){$(e).each(function(t,i){$("#"+i).length||function(t){var i=e.indexOf(t);i>-1&&e.splice(i,1),(i=o.indexOf(t))>-1&&o.splice(i,1)}(i)})},inspect:function(){return[e,o]},storeCanvasId:n,registerForReady:r}}(),window.getOEEyeDrawChecker=function(){return ED.Checker},(ED=ED||{}).Controller=function(){"use strict";var t=ED.firstLetterToUpperCase;function e(t,e,o,i,n,s,r){this.properties=t,this.canvas=document.getElementById(t.canvasId),this.input=document.getElementById(t.inputId),this.container=$(this.canvas).closest(".ed2-widget"),this.previousReport="",this.Checker=e||ED.Checker,this.drawing=o||this.createDrawing(),this.properties.isEditable&&(this.mainToolbar=i||this.createMainToolbar(),this.drawingToolbar=n||this.createDrawingToolbar(),this.doodlePopup=s||this.createDoodlePopup(),this.selectedDoodle=r||this.createSelectedDoodle(),this.bindEditEvents()),this.registerDrawing(),this.registerForNotifications(),this.initListeners(),this.drawing.init()}return e.prototype.createDrawing=function(){var t={drawingName:this.properties.drawingName,offsetX:this.properties.offsetX,offsetY:this.properties.offsetY,toImage:this.properties.toImage,graphicsPath:this.properties.graphicsPath,scale:this.properties.scale,toggleScale:this.properties.toggleScale};return new ED.Drawing(this.canvas,this.properties.eye,this.properties.idSuffix,this.properties.isEditable,t)},e.prototype.createMainToolbar=function(){var t=this.container.find(".ed2-main-toolbar");return t.length?new ED.Views.Toolbar.Main(this.drawing,t):null},e.prototype.createDrawingToolbar=function(){var t=this.container.find(".ed2-drawing-toolbar");return t.length?new ED.Views.Toolbar.Drawing(this.drawing,t):null},e.prototype.createDoodlePopup=function(){var t=this.container.find(".ed2-doodle-popup:first"),e=this.properties.showDoodlePopupForDoodles||[];return t.length?new ED.Views.DoodlePopup(this.drawing,t,e):null},e.prototype.createSelectedDoodle=function(){var t=this.container.find(".ed2-selected-doodle");return t.length?new ED.Views.SelectedDoodle(this.drawing,t,this.doodlePopup):null},e.prototype.registerDrawing=function(){this.Checker.register(this.drawing)},e.prototype.registerForNotifications=function(){this.drawing.registerForNotifications(this,"notificationHandler",["ready","doodlesLoaded","parameterChanged","doodleAdded"]),this.drawing.registerForNotifications(this,"saveDrawingToInputField",["doodleAdded","doodleDeleted","mouseup","mouseout","drawingZoom","parameterChanged"])},e.prototype.bindEditEvents=function(){this.doodlePopup&&this.doodlePopup instanceof ED.Views.DoodlePopup&&(this.doodlePopup.on("show.before",function(){this.container.addClass("ed-state-doodle-popup-show")}.bind(this)),this.doodlePopup.on("hide.after",function(){this.container.removeClass("ed-state-doodle-popup-show")}.bind(this)))},e.prototype.initListeners=function(){this.properties.listenerArray instanceof Array&&this.properties.listenerArray.forEach(function(t){new t(this.drawing)}.bind(this))},e.prototype.notificationHandler=function(e){var o=e.eventName,i="on"+t(o);this[i]&&this[i](e)},e.prototype.onDoodleAdded=function(t){const e=t.object;for(let t=0;t<e.behindClassArray.length;t++)e.drawing.moveNextTo(e,e.behindClassArray[t],!1)},e.prototype.hasInputFieldData=function(){return this.hasInputField()&&this.input.value.length>0},e.prototype.hasInputField=function(){return null!==this.input},e.prototype.saveDrawingToInputField=function(){this.hasInputField()&&this.drawing.isReady&&(this.input.value=this.drawing.save()),clearTimeout(this.saveTimer),this.saveTimer=setTimeout(function(){if(this.properties.autoReport){var t=document.getElementById(this.properties.autoReport);this.autoReport(t)}}.bind(this),200)},e.prototype.loadInputFieldData=function(){this.drawing.loadDoodles(this.properties.inputId)},e.prototype.addBindings=function(){ED.objectIsEmpty(this.properties.bindingArray)||this.drawing.addBindings(this.properties.bindingArray)},e.prototype.addDeletedValues=function(){ED.objectIsEmpty(this.properties.deleteValueArray)||this.drawing.addDeleteValues(this.properties.deleteValueArray)},e.prototype.deselectSyncedDoodles=function(){var t=this.properties.syncArray;for(var e in t)this.getEyeDrawInstance(e).deselectDoodles()},e.prototype.runOnReadyCommands=function(){var t=this.properties.onReadyCommandArray||[];this.runCommands(t),this.drawing.onReadyCommands.push(t)},e.prototype.runOnDoodlesLoadedCommands=function(){var t=this.properties.onDoodlesLoadedCommandArray||[];this.runCommands(t),null!=this.mainToolbar&&this.mainToolbar.updateState()},e.prototype.runCommands=function(t){for(var e=0;e<t.length;e++){var o=t[e][0],i=t[e][1];this.drawing[o].apply(this.drawing,i)}},e.prototype.getEyeDrawInstance=function(t){return ED.Checker.getInstanceByIdSuffix(t)},e.prototype.syncEyedraws=function(t){var e=t.doodle,o=this.properties.syncArray;for(var i in o){var n=this.getEyeDrawInstance(i);if(!n){ED.errorHandler("ED.Controller","syncEyedraws","Cannot sync with "+i+": instance not found");break}for(var s in o[i])if(e&&e.className===s)for(var r in o[i][s]){var a=n.firstDoodleOfClass(r);if(a||a.willSync){var d=o[i][s][r].parameters;this.syncDoodleParameters(d,t,e,a,n)}}n.repaint()}},e.prototype.syncDoodleParameters=function(t,e,o,i,n){for(var s=0;s<(t||[]).length;s++)if(t[s]===e.parameter&&o[e.parameter]!==i[e.parameter]){if("string"==typeof e.value)i.setParameterFromString(e.parameter,e.value,!0);else{var r=e.value-e.oldValue,a=i[e.parameter]+r;i.setSimpleParameter(e.parameter,a),i.updateDependentParameters(e.parameter)}n.updateBindings(i)}},e.prototype.onReady=function(){if(this.hasInputFieldData()?(this.loadInputFieldData(),this.drawing.repaint()):this.runOnReadyCommands(),this.addBindings(),this.addDeletedValues(),this.drawing.notifyZoomLevel(),this.properties.focus&&this.canvas.focus(),this.properties.autoReport){var t=document.getElementById(this.properties.autoReport);this.autoReport(t,this.properties.autoReportEditable)}this.drawing.isReady=!0,this.saveDrawingToInputField()},e.prototype.onDoodlesLoaded=function(){this.runOnDoodlesLoadedCommands()},e.prototype.onParameterChanged=function(t){this.syncEyedraws(t.object)},e.prototype.autoReport=function(t,e){var o=this.drawing.reportData(),i="";if(o.length){i=o.join("\n");var n="";if(!e)return void(t.value=i);var s=t.value,r=String(i).replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1");if(s.match(r))return t.rows=(s.match(/\n/g)||[]).length+1,void(this.previousReport=i);this.previousReport?n=s.replace(this.previousReport,i):(s.length&&!s.match(/^[\n ]$/)&&(s+="\n"),n=s+i),t.value=n,t.rows=(n.match(/\n/g)||[]).length+1,this.previousReport=i}else t.value="No abnormality"},e}(),(ED=ED||{}).View=function(){"use strict";var t=ED.firstLetterToUpperCase;function e(t,e){EventEmitter2.call(this),this.delayTimer=0}return e.prototype=Object.create(EventEmitter2.prototype),e.prototype.constructor=e,e.prototype.notificationHandler=function(e){var o=e.eventName,i="on"+t(o);this[i]||console.error("No handler defined for event:",i),this[i](e)},e.prototype.delay=function(t,e){clearTimeout(this.delayTimer),e="number"==typeof e?e:50,this.delayTimer=setTimeout(t,e)},e}(),(ED=ED||{}).Views=ED.Views||{},ED.Views.DoodlePopup=function(){"use strict";function t(t,e,o){ED.View.apply(this,arguments),void 0===o||o.length||(o=void 0),this.drawing=t,this.container=e,this.containerWidth=e.outerWidth(),this.popupDoodles=o,$(this.container).data("display-side")?this.side=$(this.container).data("display-side"):this.side="right",this.registerForNotifications(),this.createToolbar(),this.createHelpButton(),this.createTemplate()}return t.prototype=Object.create(ED.View.prototype),t.prototype.constructor=t,t.prototype.createToolbar=function(){this.toolbar=new ED.Views.Toolbar(this.drawing,this.container),this.toolbar.on("button.action",this.render.bind(this))},t.prototype.createHelpButton=function(){this.helpButton=new ED.Views.DoodlePopup.Help(this)},t.prototype.createTemplate=function(){this.template=ED.scriptTemplates["doodle-popup"]},t.prototype.registerForNotifications=function(){this.drawing.registerForNotifications(this,"notificationHandler",["doodleAdded","doodleDeleted","doodleSelected","doodleDeselected"])},t.prototype.render=function(){var t=this.drawing.selectedDoodle;if(t){var e={doodle:t,drawing:this.drawing,title:ED.titles[t.className],desc:ED.trans[t.className],lockedButtonClass:t.isLocked?" disabled":""},o=Mustache.render(this.template,e);try{this.container.empty()}catch(t){this.container.html("")}this.container.html(o),t.showDoodleControls(),this.emit("render")}},t.prototype.update=function(t){var e=!0;this.popupDoodles&&this.drawing.selectedDoodle&&-1==this.popupDoodles.indexOf(this.drawing.selectedDoodle.className)&&(e=!1),t&&this.drawing.selectedDoodle&&e?(this.render(),this.show()):this.hide()},t.prototype.hide=function(){this.delay(function(){this.emit("hide.before"),this.container.addClass("closed"),this.emit("hide.after");var t={};t[this.side]=0,this.container.css(t)}.bind(this))},t.prototype.show=function(){this.delay(function(){this.emit("show.before"),"left"==this.side?this.container.css({left:-1*(this.containerWidth-2)}).find(".ed-button .label").addClass("left"):this.container.css({right:-1*(this.containerWidth-1)}).find(".ed-button .label").addClass("right"),this.container.removeClass("closed"),this.emit("show.after")}.bind(this))},t.prototype.onDoodleAdded=function(){this.drawing.selectDoodle(this.drawing.selectedDoodle)},t.prototype.onDoodleDeleted=function(){this.update(!1)},t.prototype.onDoodleSelected=function(){this.update(!0)},t.prototype.onDoodleDeselected=function(){!!this.drawing.selectedDoodle||this.update(!1)},t}(),(ED=ED||{}).Views=ED.Views||{},ED.Views.DoodlePopup.Help=function(){"use strict";function t(t){return function(e){return e.button.hasClass("ed-doodle-help")&&!e.button.hasClass("disabled")&&t(e)}}function e(t){this.doodlePopup=t,this.locked=!1,this.delayTimer=0,this.bindEvents()}return e.prototype.bindEvents=function(){var e=this.doodlePopup;e.on("render",this.onDoodlePopupRender.bind(this)),e.on("hide",this.onDoodlePopupHide.bind(this));var o=e.toolbar;o.on("button.mouseenter",t(this.onButtonMouseEnter.bind(this))),o.on("button.mouseleave",t(this.onButtonMouseLeave.bind(this))),o.on("button.action",t(this.onButtonMouseClick.bind(this)))},e.prototype.showDescription=function(){clearTimeout(this.delayTimer),this.button.addClass("hover"),this.doodleInfo.show(),this.doodleControls.hide()},e.prototype.hideDescription=function(){clearTimeout(this.delayTimer),this.button.removeClass("hover"),this.doodleInfo.hide(),this.doodleControls.show()},e.prototype.onDoodlePopupRender=function(){this.doodleInfo=this.doodlePopup.container.find(".ed-doodle-info"),this.doodleControls=this.doodlePopup.container.find(".ed2-doodle-controls"),this.button=this.doodlePopup.toolbar.container.find(".ed-doodle-help")},e.prototype.onDoodlePopupHide=function(){this.locked=!1},e.prototype.onButtonMouseEnter=function(){this.delayTimer=setTimeout(this.showDescription.bind(this),300)},e.prototype.onButtonMouseLeave=function(){this.locked||this.hideDescription()},e.prototype.onButtonMouseClick=function(){this.locked?this.hideDescription():this.showDescription(),this.locked=!this.locked},e}(),(ED=ED||{}).Views=ED.Views||{},ED.Views.SelectedDoodle=function(){"use strict";function t(t,e,o){ED.View.apply(this,arguments),this.drawing=t,this.container=e,this.select=this.container.find("select"),this.doodlePopup=o,this.registerForNotifications(),this.bindEvents()}return t.prototype=Object.create(ED.View.prototype),t.prototype.constructor=t,t.prototype.registerForNotifications=function(){this.drawing.registerForNotifications(this,"render",["ready","doodleAdded","doodleDeleted","doodleSelected","doodleDeselected","doodlesLoaded","moveToFront","moveToBack","doodleLocked","doodleUnlocked"])},t.prototype.bindEvents=function(){this.select.on("change.eyedraw.selected-doodle",this.onSelectChange.bind(this))},t.prototype.render=function(){var t=$('<optgroup label="Selected doodle" />'),e=null===this.drawing.selectedDoodle;t.append(this.createOption("None",e));var o=this.drawing.doodleArray.slice();o.reverse();var i=o.map(this.createDoodleOption.bind(this));t.append(i),this.select.html(t)},t.prototype.createOption=function(t,e){return $("<option />",{text:t,selected:e})},t.prototype.createDoodleOption=function(t){if(!t.isSelectable)return $("");var e=ED.titles[t.className]||t.className,o=t===this.drawing.selectedDoodle,i=this.drawing.doodleArray.filter(function(e){return e.className===t.className}).sort(function(t,e){return t.createdTime-e.createdTime});i.length>1&&(e+=" ("+(i.indexOf(t)+1)+")");t.isLocked&&(e+=" (*)");var n=this.createOption(e,o);return n.data("doodle",t),n},t.prototype.onSelectChange=function(t){var e=$(t.target).find(":selected").data("doodle");e?this.drawing.selectDoodle(e):this.drawing.deselectDoodles()},t}(),ED.scriptTemplates={"doodle-popup":'\n\n{{#doodle}}\n{{^doodle.isNode}}\n\t<ul class="ed2-toolbar-panel ed2-doodle-popup-toolbar">\n\t\t<li>\n\t\t\t{{#desc}}\n\t\t\t\t<a class="ed-button ed2-doodle-help{{lockedButtonClass}}" href="#" data-function="toggleHelp">\n\t\t\t\t\t<i class="icon-ed-help"></i>\n\t\t\t\t</a>\n\t\t\t{{/desc}}\n\t\t</li>\n\t\t{{#doodle.isLocked}}\n\t\t\t<li>\n\t\t\t\t<a class="ed-button" href="#" data-function="unlock">\n\t\t\t\t\t<i class="icon-ed-unlock"></i>\n\t\t\t\t\t<span class="label">Unlock</span>\n\t\t\t\t</a>\n\t\t\t</li>\n\t\t{{/doodle.isLocked}}\n\t\t{{^doodle.isLocked}}\n\t\t\t<li>\n\t\t\t\t<a class="ed-button" href="#" data-function="lock">\n\t\t\t\t\t<i class="icon-ed-lock"></i>\n\t\t\t\t\t<span class="label">Lock</span>\n\t\t\t\t</a>\n\t\t\t</li>\n\t\t{{/doodle.isLocked}}\n\t\t<li>\n\t\t\t<a class="ed-button{{lockedButtonClass}}" href="#" data-function="moveToBack">\n\t\t\t\t<i class="icon-ed-move-to-back"></i>\n\t\t\t\t<span class="label">Move to back</span>\n\t\t\t</a>\n\t\t</li>\n\t\t<li>\n\t\t\t<a class="ed-button{{lockedButtonClass}}" href="#" data-function="moveToFront">\n\t\t\t\t<i class="icon-ed-move-to-front"></i>\n\t\t\t\t<span class="label">Move to front</span>\n\t\t\t</a>\n\t\t</li>\n\t\t<li>\n\t\t\t{{#doodle.isDeletable}}\n\t\t\t\t<a class="ed-button{{lockedButtonClass}}" href="#" data-function="deleteSelectedDoodle">\n\t\t\t\t\t<i class="icon-ed-delete"></i>\n\t\t\t\t\t<span class="label">Delete</span>\n\t\t\t\t</a>\n\t\t\t{{/doodle.isDeletable}}\n\t\t</li>\n\t</ul>\n\t<div class="ed2-doodle-info" style="display: none;">\n\t\t{{^doodle.isLocked}}\n\t\t\t{{#desc}}\n\t\t\t\t<div class="ed2-doodle-description">{{{desc}}}</div>\n\t\t\t{{/desc}}\n\t\t{{/doodle.isLocked}}\n\t</div>\n\t<div class="ed2-doodle-controls" {{#doodle.isLocked}}style="display: none;"{{/doodle.isLocked}} id="{{drawing.canvas.id}}_controls">\n\t</div>\n\t{{/doodle.isNode}}\n\t{{#doodle.isLocked}}\n\t\t<div class="ed2-doodle-description">\n\t\t\t<strong>This doodle is locked and cannot be edited.</strong>\n\t\t</div>\n\t{{/doodle.isLocked}}\n{{/doodle}}'},(ED=ED||{}).Views=ED.Views||{},ED.Views.Toolbar=function(){"use strict";function t(t,e){ED.View.apply(this,arguments),this.drawing=t,this.container=$(e),this.buttons=this.container.find(".ed-button"),this.registerForNotifications(),this.bindEvents()}return t.prototype=Object.create(ED.View.prototype),t.prototype.constructor=t,t.prototype.registerForNotifications=function(){this.drawing.registerForNotifications(this,"updateState",["doodleAdded","doodleDeleted"])},t.prototype.bindEvents=function(){$(document).click(this.hideDrawers.bind(this)),this.container.on("click.eyedraw.toolbar",".ed-button-more",this.onMoreButtonClick.bind(this)).on("click.eyedraw.toolbar",".ed-button",this.onButtonClick.bind(this)).on("mouseenter.eyedraw.toolbar",".ed-button",this.onButtonMouseEnter.bind(this)).on("mouseleave.eyedraw.toolbar",".ed-button",this.onButtonMouseLeave.bind(this))},t.prototype.enableButton=function(t){t.attr("disabled",!1).removeClass("disabled")},t.prototype.disableButton=function(t){t.attr("disabled",!0).addClass("disabled")},t.prototype.updateButtonState=function(t){this.enableButton(t);var e=t.data("function"),o=t.data("arg");if("addDoodle"===e){var i=this.drawing.doodleArray.filter(function(t){return t.className===o})[0];i&&i.isUnique&&this.disableButton(t)}},t.prototype.updateState=function(){this.buttons.each(function(t,e){this.updateButtonState($(e))}.bind(this))},t.prototype.execButtonFunction=function(t){if(!t.hasClass("disabled")){var e=t.data("function"),o=t.data("arg");e&&"function"==typeof this.drawing[e]?this.drawing[e](o):this.emit("button.error","Invalid doodle function: "+e),this.emit("button.action",{fn:e,arg:o,button:t})}},t.prototype.hideDrawers=function(){this.container.find(".ed2-drawer-open").removeClass("ed2-drawer-open")},t.prototype.onButtonClick=function(t){t.preventDefault(),t.stopImmediatePropagation(),this.hideDrawers();var e=$(t.currentTarget);this.execButtonFunction(e)},t.prototype.onMoreButtonClick=function(t){t.preventDefault(),t.stopImmediatePropagation(),this.hideDrawers(),$(t.currentTarget).closest("li").addClass("ed2-drawer-open")},t.prototype.onButtonMouseEnter=function(t){this.emit("button.mouseenter",{button:$(t.currentTarget)})},t.prototype.onButtonMouseLeave=function(t){this.emit("button.mouseleave",{button:$(t.currentTarget)})},t}(),ED.Views.Toolbar.Drawing=function(){function t(t,e){ED.Views.Toolbar.apply(this,arguments),this.zoomIcon=this.container.find("[class^=icon-ed-zoom]")}return t.prototype=Object.create(ED.Views.Toolbar.prototype),t.prototype.constructor=t,t.prototype.registerForNotifications=function(){ED.Views.Toolbar.prototype.registerForNotifications.apply(this,arguments),this.drawing.registerForNotifications(this,"handleZoom",["drawingZoomOut","drawingZoomIn"])},t.prototype.handleZoom=function(t){switch(t.eventName){case"drawingZoomIn":this.updateIcon("icon-ed-zoom-out");break;case"drawingZoomOut":this.updateIcon("icon-ed-zoom-in")}},t.prototype.updateIcon=function(t){this.zoomIcon.removeClass("icon-ed-zoom-in icon-ed-zoom-out").addClass(t)},t}(),ED.Views.Toolbar.Main=function(){function t(t,e){ED.Views.Toolbar.apply(this,arguments)}return t.prototype=Object.create(ED.Views.Toolbar.prototype),t.prototype.constructor=t,t}();